<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"kjgggggg.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":false,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"./public/public/search.xml"};
  </script>

  <meta name="description" content="MIT6.824">
<meta property="og:type" content="article">
<meta property="og:title" content="MIT6.824">
<meta property="og:url" content="https://kjgggggg.github.io/2022/09/01/MIT6-824/index.html">
<meta property="og:site_name" content="kjg&#39;s blog">
<meta property="og:description" content="MIT6.824">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://kjgggggg.github.io/2022/09/01/MIT6-824/image-20230401215921894.png">
<meta property="og:image" content="https://kjgggggg.github.io/2022/09/01/MIT6-824/image-20230403000919945.png">
<meta property="og:image" content="https://kjgggggg.github.io/2022/09/01/MIT6-824/image-20230405191056704.png">
<meta property="og:image" content="https://kjgggggg.github.io/2022/09/01/MIT6-824/image-20230405195601354.png">
<meta property="article:published_time" content="2022-09-01T13:18:15.000Z">
<meta property="article:modified_time" content="2023-04-07T07:06:35.667Z">
<meta property="article:author" content="kjg">
<meta property="article:tag" content="MIT6.824">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://kjgggggg.github.io/2022/09/01/MIT6-824/image-20230401215921894.png">

<link rel="canonical" href="https://kjgggggg.github.io/2022/09/01/MIT6-824/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>MIT6.824 | kjg's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">kjg's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://kjgggggg.github.io/2022/09/01/MIT6-824/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/WechatIMG84.jpeg">
      <meta itemprop="name" content="kjg">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kjg's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          MIT6.824
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-09-01 21:18:15" itemprop="dateCreated datePublished" datetime="2022-09-01T21:18:15+08:00">2022-09-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-04-07 15:06:35" itemprop="dateModified" datetime="2023-04-07T15:06:35+08:00">2023-04-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MIT6-824/" itemprop="url" rel="index"><span itemprop="name">MIT6.824</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
            <div class="post-description">MIT6.824</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h3 id="文件结构"><a href="#文件结构" class="headerlink" title="文件结构"></a>文件结构</h3><figure class="highlight go"><table><tr><td class="code"><pre><span class="line">/Users/jiangangkong/workSpace/vscodeWorkSpace/<span class="number">6.824</span></span><br><span class="line">- Makefile	</span><br><span class="line">- src</span><br><span class="line">    - <span class="keyword">go</span>.mod		</span><br><span class="line">    - labgob		</span><br><span class="line">		labgob.<span class="keyword">go</span>	test_test.<span class="keyword">go</span></span><br><span class="line">    - models		</span><br><span class="line">		kv.<span class="keyword">go</span></span><br><span class="line">    - porcupine	</span><br><span class="line">		bitset.<span class="keyword">go</span>		model.<span class="keyword">go</span>		visualization.<span class="keyword">go</span></span><br><span class="line">		checker.<span class="keyword">go</span>		porcupine.<span class="keyword">go</span></span><br><span class="line">    - shardkv</span><br><span class="line">		client.<span class="keyword">go</span>	common.<span class="keyword">go</span>	config.<span class="keyword">go</span>	server.<span class="keyword">go</span>	test_test.<span class="keyword">go</span></span><br><span class="line">    - <span class="keyword">go</span>.sum		</span><br><span class="line">    - labrpc	</span><br><span class="line">		labrpc.<span class="keyword">go</span>	test_test.<span class="keyword">go</span></span><br><span class="line">    - mr		</span><br><span class="line">		coordinator.<span class="keyword">go</span>	  rpc.<span class="keyword">go</span>	worker.<span class="keyword">go</span></span><br><span class="line">    - raft</span><br><span class="line">		config.<span class="keyword">go</span>	persister.<span class="keyword">go</span>	raft.<span class="keyword">go</span>		test_test.<span class="keyword">go</span>	util.<span class="keyword">go</span></span><br><span class="line">    - kvraft</span><br><span class="line">		client.<span class="keyword">go</span>	common.<span class="keyword">go</span>	config.<span class="keyword">go</span>	server.<span class="keyword">go</span>	test_test.<span class="keyword">go</span></span><br><span class="line">    - main	</span><br><span class="line">		diskvd.<span class="keyword">go</span>			pbd.<span class="keyword">go</span>					pg-sherlock_holmes.txt</span><br><span class="line">        lockc.<span class="keyword">go</span>			pg-being_ernest.txt		pg-tom_sawyer.txt</span><br><span class="line">        lockd.<span class="keyword">go</span>			pg-dorian_gray.txt		test-mr-many.sh</span><br><span class="line">        mrcoordinator.<span class="keyword">go</span>	pg-frankenstein.txt		test-mr.sh</span><br><span class="line">        mrsequential.<span class="keyword">go</span>		pg-grimm.txt			viewd.<span class="keyword">go</span></span><br><span class="line">        mrworker.<span class="keyword">go</span>			pg-huckleberry_finn.txt</span><br><span class="line">        pbc.<span class="keyword">go</span>				pg-metamorphosis.txt</span><br><span class="line">    - mrapps	</span><br><span class="line">		crash.<span class="keyword">go</span>		indexer.<span class="keyword">go</span>		mtiming.<span class="keyword">go</span>		rtiming.<span class="keyword">go</span></span><br><span class="line">		early_exit.<span class="keyword">go</span>	jobcount.<span class="keyword">go</span>		nocrash.<span class="keyword">go</span>		wc.<span class="keyword">go</span></span><br><span class="line">    - shardctrler</span><br><span class="line">		client.<span class="keyword">go</span>	common.<span class="keyword">go</span>	config.<span class="keyword">go</span>	server.<span class="keyword">go</span>	test_test.<span class="keyword">go</span></span><br></pre></td></tr></table></figure>







<h3 id="Lab-1-MapReduce"><a href="#Lab-1-MapReduce" class="headerlink" title="Lab 1: MapReduce"></a>Lab 1: MapReduce</h3><p><strong>Introduction</strong></p>
<p>在本实验中，您将构建一个MapReduce系统。您将实现一个调用应用程序Map和Reduce函数并处理文件读写的工作进程，以及一个将任务分发给workers进程并处理失败的工作进程的master进程。您将构建与MapReduce论文类似的东西</p>
<p><strong>Getting started</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /Users/jiangangkong/workSpace/vscodeWorkSpace</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> git://g.csail.mit.edu/6.824-golabs-2020 6.824</span><br><span class="line"><span class="built_in">cd</span> 6.824</span><br><span class="line"><span class="built_in">ls</span></span><br></pre></td></tr></table></figure>

<img src="/2022/09/01/MIT6-824/image-20230401215921894.png" alt="image-20230401215921894" style="zoom:50%;">

<p>我们在 <code>src/main/mrsequential.go</code>为你提供了一个简单的  sequential mapreduce 实现  It runs the maps and reduces one at a time, in a single process. </p>
<p>We also provide you with a couple of MapReduce applications:  </p>
<p>单词计数器 <code>mrapps/wc.go</code>,  文本索引器  <code>mrapps/indexer.go</code>. 你可以按如下指令运行它们</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /Users/jiangangkong/workSpace/vscodeWorkSpace/6.824</span><br><span class="line"><span class="built_in">cd</span> src/main</span><br><span class="line"><span class="comment"># 使用 Go 工具链中的 go build 命令来构建一个插件，插件的源代码是 ../mrapps/wc.go 文件</span></span><br><span class="line">go build -buildmode=plugin ../mrapps/wc.go</span><br><span class="line"><span class="comment"># 删除所有以 &quot;mr-out&quot; 开头的文件，例如 &quot;mr-out-1.txt&quot;，&quot;mr-out-2.txt&quot;</span></span><br><span class="line"><span class="built_in">rm</span> mr-out*</span><br><span class="line"><span class="comment"># 使用wc.so作业和所有以pg开头并以.txt结尾的当前目录中的文件作为输入来运行mrsequential.go程序</span></span><br><span class="line"><span class="comment"># mrsequential.go 程序将读取输入文件，使用 wc.so 作业进行处理，并输出结果</span></span><br><span class="line">go run mrsequential.go wc.so pg*.txt </span><br><span class="line">more mr-out-0 <span class="comment"># 查看文件内容 Q退出more模式</span></span><br></pre></td></tr></table></figure>

<p>请随意从mrsequence .go中借用代码。您还应该看看mrapps&#x2F;wc。去看看MapReduce应用程序代码是什么样的</p>
<p><strong>Your Job</strong></p>
<p>您的工作是实现一个分布式MapReduce，由两个程序组成, the master and the worker. There will be just one master process, and one or more worker processes executing in parallel. </p>
<p>The workers will talk to the master via RPC. Each worker process will ask the master for a task, read the task’s input from one or more files, execute the task, and write the task’s output to one or more files. The master should notice if a worker hasn’t completed its task in a reasonable amount of time (for this lab, use ten seconds), and give the same task to a different worker.</p>
<p>为方便你开始，The “main” routines for the master and worker are in <code>main/mrmaster.go</code> and <code>main/mrworker.go</code>; </p>
<p>don’t change these files. Put your implementation in <code>mr/master.go</code>, <code>mr/worker.go</code>, and <code>mr/rpc.go</code>.</p>
<p><strong>Run your code</strong></p>
<p>Here’s how to run your code on the word-count MapReduce application.</p>
<p>First, make sure the word-count plugin is freshly built:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">go build -buildmode=plugin ../mrapps/wc.go</span><br></pre></td></tr></table></figure>

<p>In the <code>main</code> directory, run the master.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">rm</span> mr-out*</span><br><span class="line">go run mrmaster.go pg-*.txt</span><br></pre></td></tr></table></figure>

<p>The <code>pg-*.txt</code> arguments to <code>mrmaster.go</code> are the input files; each file corresponds to one “split”, and is the input to one Map task.</p>
<p>In one or more other windows, run some workers:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">go run mrworker.go wc.so</span><br></pre></td></tr></table></figure>

<p>When the workers and master have finished, look at the output in <code>mr-out-*</code>. When you’ve completed the lab, the sorted union of the output files should match the sequential output, like this:</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line"><span class="keyword">cat</span> mr-<span class="keyword">out</span>-* | <span class="keyword">sort</span> | <span class="keyword">more</span></span><br><span class="line"></span><br><span class="line">A 509</span><br><span class="line"><span class="keyword">ABOUT</span> 2</span><br><span class="line">ACT 8</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>We supply you with a test script in <code>main/test-mr.sh</code>. The tests check that the <code>wc</code> and <code>indexer</code> MapReduce applications produce the correct output when given the <code>pg-xxx.txt</code> files as input. The tests also check that your implementation runs the Map and Reduce tasks in parallel, and that your implementation recovers from workers that crash while running tasks.</p>
<p>If you run the test script now, it will hang because the master never finishes:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/6.824/src/main</span><br><span class="line">sh test-mr.sh</span><br><span class="line">*** Starting <span class="built_in">wc</span> <span class="built_in">test</span>.</span><br></pre></td></tr></table></figure>

<p>You can change <code>ret := false</code> to true in the Done function in <code>mr/master.go</code> so that the master exits immediately. Then:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sh ./test-mr.sh</span><br><span class="line">*** Starting <span class="built_in">wc</span> <span class="built_in">test</span>.</span><br><span class="line"><span class="built_in">sort</span>: No such file or directory</span><br><span class="line">cmp: EOF on mr-wc-all</span><br><span class="line">--- <span class="built_in">wc</span> output is not the same as mr-correct-wc.txt</span><br><span class="line">--- <span class="built_in">wc</span> <span class="built_in">test</span>: FAIL</span><br></pre></td></tr></table></figure>

<p>The test script expects to see output in files named <code>mr-out-X</code>, one for each reduce task. The empty implementations of <code>mr/master.go</code> and <code>mr/worker.go</code> don’t produce those files (or do much of anything else), so the test fails.</p>
<p>When you’ve finished, the test script output should look like this:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sh ./test-mr.sh</span><br><span class="line">*** Starting <span class="built_in">wc</span> <span class="built_in">test</span>.</span><br><span class="line">--- <span class="built_in">wc</span> <span class="built_in">test</span>: PASS</span><br><span class="line">*** Starting indexer <span class="built_in">test</span>.</span><br><span class="line">--- indexer <span class="built_in">test</span>: PASS</span><br><span class="line">*** Starting map parallelism <span class="built_in">test</span>.</span><br><span class="line">--- map parallelism <span class="built_in">test</span>: PASS</span><br><span class="line">*** Starting reduce parallelism <span class="built_in">test</span>.</span><br><span class="line">--- reduce parallelism <span class="built_in">test</span>: PASS</span><br><span class="line">*** Starting crash <span class="built_in">test</span>.</span><br><span class="line">--- crash <span class="built_in">test</span>: PASS</span><br><span class="line">*** PASSED ALL TESTS</span><br></pre></td></tr></table></figure>

<p>You’ll also see some errors from the Go RPC package that look like</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">2019/12/16 13:27:09 rpc.Register: method <span class="string">&quot;Done&quot;</span> has 1 input parameters; needs exactly three</span><br></pre></td></tr></table></figure>

<p>Ignore these messages.</p>
<h4 id="A-few-rules"><a href="#A-few-rules" class="headerlink" title="A few rules:"></a>A few rules:</h4><ul>
<li><p>map 阶段 should divide the intermediate keys into buckets for <code>nReduce</code> reduce tasks, where <code>nReduce</code> is the argument that <code>main/mrmaster.go</code> passes to <code>MakeMaster()</code>.</p>
</li>
<li><p>The worker implementation should put the output of the X’th reduce task in the file <code>mr-out-X</code>.</p>
</li>
<li><p>A <code>mr-out-X</code> file should contain one line per Reduce function output. The line should be generated with the Go <code>&quot;%v %v&quot;</code> format, called with the key and value. Have a look in <code>main/mrsequential.go</code></p>
</li>
<li><p><code>main/mrmaster.go</code> expects <code>mr/master.go</code> to implement a <code>Done()</code> method that returns true when the MapReduce job is completely finished; at that point, <code>mrmaster.go</code> will exit.</p>
</li>
<li><p>When the job is completely finished, the worker processes should exit. A simple way to implement this is to use the return value from <code>call()</code>: if the worker fails to contact the master, it can assume that the master has exited because the job is done, and so the worker can terminate too. Depending on your design, you might also find it helpful to have a “please exit” pseudo-task （伪任务） that the master can give to workers</p>
</li>
</ul>
<h4 id="Hints"><a href="#Hints" class="headerlink" title="Hints"></a>Hints</h4><ul>
<li><p><strong>One way to get started</strong> is to modify <code>mr/worker.go</code>中的 <code>Worker()</code> to send an RPC to the master asking for a task. Then modify the master to respond with the file name of an 尚未启动的 map task. Then modify the worker to read that file and call the application Map function, as in <code>mrsequential.go</code>.</p>
</li>
<li><p>中间文件的合理命名约定是mr-X-Y，其中X是Map任务编号，Y是reduce任务编号</p>
</li>
<li><p>Workers的map部分可以使用ihash(key)函数为给定的key选择reduce任务</p>
</li>
<li><p>Workers 有时需要等待，reduces can’t start until the last map has finished. One possibility is for workers to periodically ask the master for work, sleeping with <code>time.Sleep()</code> between each request. Another possibility is for the relevant RPC handler in the master to have a loop that waits, either with <code>time.Sleep()</code> or <code>sync.Cond</code>. Go runs the handler for each RPC in its own thread, so the fact that one handler is waiting won’t prevent the master from processing other RPCs.</p>
</li>
</ul>
<h4 id="※流程"><a href="#※流程" class="headerlink" title="※流程"></a>※流程</h4><p><img src="/2022/09/01/MIT6-824/image-20230403000919945.png" alt="image-20230403000919945"></p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">run main/mrcoordinator.<span class="keyword">go</span> XXX*.txt</span><br><span class="line">-&gt; 调用 mr/coordinator.<span class="keyword">go</span>/MakeCoordinator() 初始化 c *Coordinato  </span><br><span class="line">-&gt; 调用 c.server() start a thread that listens <span class="keyword">for</span> RPCs from worker.<span class="keyword">go</span></span><br><span class="line">-&gt; 调用 <span class="keyword">go</span> c.schedule() 启动一个线程调度任务执行，根据阶段和任务状态分配新任务，</span><br><span class="line">   处理工作节点的心跳和报告信息，并将任务分配给空闲工作节点</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span></span> schedule() &#123;</span><br><span class="line">	c.initMapPhase() <span class="comment">// 进入 Map 流程, 将所有.txt文件封装成task 放入 c.tasks</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 进入一个无限循环中，通过 select 语句监听两个通道：heartbeatCh 和 reportCh</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="comment">// 当从heartbeatCh中收到消息时, 它会根据当前任务的阶段</span></span><br><span class="line">        <span class="comment">//（MapPhase、ReducePhase 或 CompletePhase）来选择一个任务并将其分配给一个可用的 Worker</span></span><br><span class="line">		<span class="keyword">case</span> msg := &lt;-c.heartbeatCh:</span><br><span class="line">			<span class="keyword">if</span> c.phase == CompletePhase &#123;</span><br><span class="line">				msg.response.JobType = CompleteJob</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> c.selectTask(msg.response) &#123;</span><br><span class="line">				<span class="keyword">switch</span> c.phase &#123;</span><br><span class="line">				<span class="keyword">case</span> MapPhase:</span><br><span class="line">					log.Printf(<span class="string">&quot;Coordinator: %v finished, start %v \n&quot;</span>, MapPhase, ReducePhase)</span><br><span class="line">					c.initReducePhase()</span><br><span class="line">					c.selectTask(msg.response) <span class="comment">// 并改写 msg.response</span></span><br><span class="line">				<span class="keyword">case</span> ReducePhase:</span><br><span class="line">					log.Printf(<span class="string">&quot;Coordinator: %v finished, Congratulations \n&quot;</span>, ReducePhase)</span><br><span class="line">					c.initCompletePhase()</span><br><span class="line">					msg.response.JobType = CompleteJob</span><br><span class="line">				<span class="keyword">case</span> CompletePhase:</span><br><span class="line">					<span class="built_in">panic</span>(fmt.Sprintf(<span class="string">&quot;Coordinator: enter unexpected branch&quot;</span>))</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			log.Printf(<span class="string">&quot;Coordinator: assigned a task %v to worker \n&quot;</span>, msg.response)</span><br><span class="line">			msg.ok &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">		<span class="keyword">case</span> msg := &lt;-c.reportCh:</span><br><span class="line">			<span class="keyword">if</span> msg.request.Phase == c.phase &#123;</span><br><span class="line">				log.Printf(<span class="string">&quot;Coordinator: Worker has executed task %v \n&quot;</span>, msg.request)</span><br><span class="line">				c.tasks[msg.request.Id].status = Finished</span><br><span class="line">			&#125;</span><br><span class="line">			msg.ok &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="Worker-模块"><a href="#Worker-模块" class="headerlink" title="Worker 模块"></a>Worker 模块</h5><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 只有 doHeartbeat 可能引起状态的转换，doReport 是一个worker 进程完成了</span></span><br><span class="line">main/mrworker.<span class="keyword">go</span> calls mr/mrworker.<span class="keyword">go</span>/Worker()</span><br><span class="line">-&gt; Worker() 首先 doHeartbeat()</span><br><span class="line">拿到 response := doHeartbeat() 后，将 response 传给 doMapTask/ doReduceTask</span><br><span class="line">-&gt; 根据response.JobType 决定 doMapTask()/doReduceTask() 会 doReport()</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doHeartbeat</span><span class="params">()</span></span> *HeartbeatResponse &#123;</span><br><span class="line">	response := HeartbeatResponse&#123;&#125;</span><br><span class="line">	call(<span class="string">&quot;Coordinator.Heartbeat&quot;</span>, &amp;HeartbeatRequest&#123;&#125;, &amp;response)</span><br><span class="line">	<span class="keyword">return</span> &amp;response</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doReport</span><span class="params">(id <span class="type">int</span>, phase SchedulePhase)</span></span> &#123;</span><br><span class="line">	call(<span class="string">&quot;Coordinator.Report&quot;</span>, &amp;ReportRequest&#123;id, phase&#125;, &amp;ReportResponse&#123;&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Lab-2A-Raft"><a href="#Lab-2A-Raft" class="headerlink" title="Lab 2A: Raft"></a>Lab 2A: Raft</h3><p>选举：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span> 一开始，集群内所有节点都是follower状态，term都为<span class="number">1</span>,各节点维护自己的election_timeout</span><br><span class="line"><span class="number">2.</span> 如果在某节点election_timeout到达时还没有收到Leader节点的心跳，就会发起新一轮的Leader选举过程</span><br><span class="line"><span class="number">3.</span> 此时S2节点最先超时，现将自己term+<span class="number">1</span>变为<span class="number">2</span>, 将自己的状态切换为Candidate状态，投自己一票，并向其余所有节点发起Request Vote RPC请求</span><br><span class="line"><span class="number">4.</span> 由于目前集群中只有一个Candidate，因此其余节点都投了赞成票，然后将自己的term都+<span class="number">1</span>保持与Candidate节点一致的状态</span><br><span class="line"><span class="number">5.</span> 由于S2节点都到了超过集群机器数一半的票数，当选为Leader节点，状态转换为Leader，S2称为Leader后会不断向其他节点发心跳</span><br></pre></td></tr></table></figure>





<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">type Raft <span class="keyword">struct</span> &#123;</span><br><span class="line">	mu        sync.RWMutex        <span class="comment">// Lock to protect shared access to this peer&#x27;s state</span></span><br><span class="line">	peers     []*labrpc.ClientEnd <span class="comment">// RPC end points of all peers</span></span><br><span class="line">	persister *Persister          <span class="comment">// Object to hold this peer&#x27;s persisted state</span></span><br><span class="line">	me        <span class="type">int</span>                 <span class="comment">// this peer&#x27;s index into peers[]</span></span><br><span class="line">	dead      int32               <span class="comment">// set by Kill()</span></span><br><span class="line"></span><br><span class="line">	applyCh        chan ApplyMsg</span><br><span class="line">	applyCond      *sync.Cond   <span class="comment">// used to wakeup applier goroutine after committing new entries</span></span><br><span class="line">	replicatorCond []*sync.Cond <span class="comment">// used to signal replicator goroutine to batch replicating entries</span></span><br><span class="line">	state          NodeState</span><br><span class="line"></span><br><span class="line">	currentTerm <span class="type">int</span></span><br><span class="line">	votedFor    <span class="type">int</span></span><br><span class="line">	logs        []Entry <span class="comment">// the first entry is a dummy entry which contains LastSnapshotTerm, LastSnapshotIndex and nil Command</span></span><br><span class="line"></span><br><span class="line">	commitIndex <span class="type">int</span>   <span class="comment">// 已经被提交的日志条目的索引</span></span><br><span class="line">	lastApplied <span class="type">int</span>   <span class="comment">// 已经被应用到状态机的日志条目的索引</span></span><br><span class="line">	nextIndex   []<span class="type">int</span> <span class="comment">// 表示该节点对于每个peer节点需要发送的下一个日志条目的索引</span></span><br><span class="line">	matchIndex  []<span class="type">int</span> <span class="comment">// 表示该节点已知的每个peer节点已经复制的最高日志条目的索引</span></span><br><span class="line"></span><br><span class="line">	electionTimer  *time.Timer</span><br><span class="line">	heartbeatTimer *time.Timer</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> GetState() (<span class="type">int</span>, <span class="type">bool</span>)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> GetRaftStateSize() <span class="type">int</span> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> persist()</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> readPersist(data []<span class="type">byte</span>)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> encodeState() []<span class="type">byte</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> CondInstallSnapshot(lastIncludedTerm <span class="type">int</span>, lastIncludedIndex <span class="type">int</span>, snapshot []<span class="type">byte</span>) <span class="type">bool</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> Snapshot(index <span class="type">int</span>, snapshot []<span class="type">byte</span>)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> RequestVote(request *RequestVoteRequest, response *RequestVoteResponse)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> AppendEntries(request *AppendEntriesRequest, response *AppendEntriesResponse) </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> InstallSnapshot(request *InstallSnapshotRequest, response *InstallSnapshotResponse)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> sendRequestVote(server <span class="type">int</span>, request *RequestVoteRequest, response *RequestVoteResponse) <span class="type">bool</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> sendAppendEntries(server <span class="type">int</span>, request *AppendEntriesRequest, response *AppendEntriesResponse) <span class="type">bool</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> sendInstallSnapshot(server <span class="type">int</span>, request *InstallSnapshotRequest, response *InstallSnapshotResponse) <span class="type">bool</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> StartElection()</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> BroadcastHeartbeat(isHeartBeat <span class="type">bool</span>) </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> replicateOneRound(peer <span class="type">int</span>)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> genRequestVoteRequest() *RequestVoteRequest</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> genAppendEntriesRequest(prevLogIndex <span class="type">int</span>) *AppendEntriesRequest</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> handleAppendEntriesResponse(peer <span class="type">int</span>, request *AppendEntriesRequest, response *AppendEntriesResponse) </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> genInstallSnapshotRequest() *InstallSnapshotRequest</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> handleInstallSnapshotResponse(peer <span class="type">int</span>, request *InstallSnapshotRequest, response *InstallSnapshotResponse)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> ChangeState(state NodeState) </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> advanceCommitIndexForLeader()</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> advanceCommitIndexForFollower(leaderCommit <span class="type">int</span>)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> getLastLog() Entry</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> getFirstLog() Entry</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> isLogUpToDate(term, index <span class="type">int</span>) <span class="type">bool</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> matchLog(term, index <span class="type">int</span>) <span class="type">bool</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> appendNewEntry(command <span class="keyword">interface</span>&#123;&#125;) Entry</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> needReplicating(peer <span class="type">int</span>) <span class="type">bool</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> HasLogInCurrentTerm() <span class="type">bool</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> Start(command <span class="keyword">interface</span>&#123;&#125;) (<span class="type">int</span>, <span class="type">int</span>, <span class="type">bool</span>)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> Kill()</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> killed() <span class="type">bool</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> Me() <span class="type">int</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> ticker()</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> applier() </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> replicator(peer <span class="type">int</span>)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Make</span><span class="params">(peers []*labrpc.ClientEnd, me <span class="type">int</span>, persister *Persister, applyCh <span class="keyword">chan</span> ApplyMsg)</span></span> *Raft</span><br></pre></td></tr></table></figure>









<h3 id="Lab3-高可用的-KV-存储服务"><a href="#Lab3-高可用的-KV-存储服务" class="headerlink" title="Lab3:高可用的 KV 存储服务"></a>Lab3:高可用的 KV 存储服务</h3><h4 id="1-Finding-the-cluster"><a href="#1-Finding-the-cluster" class="headerlink" title="1. Finding the cluster"></a>1. Finding the cluster</h4><p>当Raft被公开为网络服务时，客户机必须定位集群以便与复制状态机交互。对于具有固定成员的集群，这很简单;例如,服务器的网络地址可以静态存储在配置文件中。</p>
<p>然而当它的服务器集可以随时间变化时，发现集群是一个更大的挑战。一般有两种方法:</p>
<ol>
<li>客户端可以使用广播或多播来查找所有集群服务器。然而，这将只能在支持这些特性的特定环境中工作。</li>
<li>是客户端通过外部目录服务(如DNS)找到集群中的服务器，并在集群成员更改时更新目录</li>
</ol>
<blockquote>
<p>  LogCabin客户端目前使用DNS来查找集群。</p>
<p>  LogCabin目前不自动更新DNS在成员更改之前和之后的记录(这交给管理脚本)</p>
</blockquote>
<p><img src="/2022/09/01/MIT6-824/image-20230405191056704.png" alt="image-20230405191056704"></p>
<p>Clients 使用 ClientRequest RPC 修改 replicated state;</p>
<p>Clients 使用 ClientQuery RPC 查询 replicated state. </p>
<p>New Clients 通过 RegisterClient RPC 接收他们的 client identifier , which helps identify when session information needed for linearizability has been discarded. </p>
<p>不是leader 的服务器 redirect clients to the leader, and read-only requests are serviced without relying on clocks for linearizability (本文提出了替代方案). </p>
<h4 id="2-Routing-requests-to-the-leader"><a href="#2-Routing-requests-to-the-leader" class="headerlink" title="2. Routing requests to the leader"></a>2. Routing requests to the leader</h4><p>Raft中的客户端请求是通过leader处理的。当客户端第一次启动时，它连接到一个随机选择的服务器。如果客户的选择不是leader，该服务器拒绝请求。如果客户端暴力枚举并标记选过的server，那么n大小的集群平均需要n+1&#x2F;2次尝试，对于小的集群已经足够快了</p>
<p>通过简单的优化也可以更快地将请求路由到leader。follower服务器通常知道当前集群leader的地址，因为AppendEntries请求包括leader的地址。当不是leader的服务器接收到来自客户端的请求时，它可以执行两种操作中的一种：</p>
<ol>
<li>我们推荐的也是LogCabin实现的，是让服务拒绝请求并返回leader的地址(如果已知)给客户端</li>
<li>服务器可以将客户端的请求代理给领导者。这可能更简单</li>
</ol>
<p>Raft 还必须防止陈旧的leader信息无限期地延迟客户请求。信息可能会在整个系统中变得陈旧，包括leader、follower和client：</p>
<ul>
<li><p>leader：A server might be in the leader state, but if it isn’t the current leader, it could be needlessly delaying client requests. For example, suppose a leader is partitioned from the rest of the cluster, but it can still communicate with a particular client. Without additional mechanism, it could delay a request from that client forever, being unable to replicate a log entry to any other servers.Meanwhile, there might be another leader of a newer term that is able to communicate with a majority of the cluster and would be able to commit the client’s request. Thus, a leader in Raft steps down if an election timeout elapses without a successful round of heartbeats to a majority of its cluster; this allows clients to retry their requests with another server.</p>
</li>
<li><p>follower：follower跟踪leader的身份，以便他们可以重定向或代理客户。 他们必须在开始新的选举或任期届满时丢弃这些信息。 否则，他们可能会不必要地延迟客户（例如，有可能两个服务器相互重定向，将客户端置于无限循环中）。</p>
</li>
<li><p>client：如果客户端失去与leader（或任何特定服务器）的连接，它应该只需使用随机服务器重试。 坚持能够联系最后一个已知的领导者.如果该服务器出现故障，将导致不必要的延迟。</p>
</li>
</ul>
<h4 id="3-Implementing-linearizable-semantics语义"><a href="#3-Implementing-linearizable-semantics语义" class="headerlink" title="3. Implementing linearizable semantics语义"></a>3. Implementing linearizable semantics语义</h4><blockquote>
<p>  即实现对KV 存储服务操作的幂等性</p>
<p>  在后端开发中，幂等性指的是一个操作的执行结果在多次重复执行时，产生的效果与仅执行一次的效果相同。简单来说，就是对于同一个操作，多次执行所产生的结果和仅执行一次的结果相同。</p>
<p>  幂等性是一个非常重要的概念，因为在分布式系统中，由于网络的不可靠性和消息重复的可能性，会导致同一个请求被多次执行，如果该请求是非幂等的，则可能会导致系统数据的错误或者不一致。而如果该请求是幂等的，则可以保证系统数据的正确性和一致性。</p>
</blockquote>
<ul>
<li><p>每个要做proposal的client需要一个唯一的identifier，它的每个<strong>不同</strong>proposal需要有一个顺序递增的序列号，client id和这个序列号由此可以唯一确定一个不同的proposal，从而使得各个raft节点可以记录保存各proposal应用以后的结果。</p>
</li>
<li><p>当一个proposal超时，client不提高proposal的序列号，使用原proposal序列号重试。</p>
</li>
<li><p>当一个proposal被成功提交并应用且被成功回复给client以后，client顺序提高proposal的序列号，并记录下收到的成功回复的proposal的序列号。raft节点收到一个proposal请求以后，得到请求中夹带的这个最大成功回复的proposal的序列号，它和它之前所有的应用结果都可以删去。proposal序列号和client id可用于判断这个proposal是否应用过，如果已经应用过，则不再再次应用，直接返回已保存的结果。<strong>等于是每个不同的proposal可以被commit多次，在log中出现多次，但永远只会被apply一次。</strong></p>
</li>
<li><p>系统维护一定数量允许的client数量，比如可以用LRU策略淘汰。请求过来了，而client已经被LRU淘汰掉了，则让client直接fail掉。</p>
</li>
<li><p>这些已经注册的client信息，包括和这些client配套的上述proposal结果、各序列号等等，需要在<a target="_blank" rel="noopener" href="https://www.zhihu.com/search?q=raft%E7%BB%84&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22:%22answer%22,%22sourceId%22:400962941%7D">raft组</a>内一致的维护。也就是说，<strong>上述各raft端数据结构和它们的操作实际是state machine的一部分</strong>。在做snapshotting的时候，它们同样需要被保存与恢复。</p>
</li>
</ul>
<p>以下是论文⬇️</p>
<hr>
<hr>
<p>假设一个client 向leader发送了一条命令 and the leader appends the command 并提交了log条目, 但是leader在回复client前崩溃了。</p>
<p>由于客户端没有收到确认，所以它将命令重新提交给新的leader，它反过来将命令作为一个新条目追加到它的日志中，并提交这个新条目。尽管客户端希望命令执行一次，但实际上执行了两次。</p>
<p>如果网络可以复制客户端的请求，即使没有客户端的参与，命令也可以应用多次。</p>
<p>这个问题并不是Raft独有的;它出现在大多数<strong>有状态的</strong>分布式系统中。然而,这些“至少一次”语义特别不适合基于共识的系统，在这种系统中客户通常需要更强的保证。</p>
<p>重复命令的问题可能会以微妙的方式表现出来，client很难从中恢复过来。 </p>
<p>这些问题会导致不正确的结果或不正确的状态。 图 6.2 显示了一个错误结果的示例：状态机正在提供锁，而客户端发现它无法获取锁，因为它的原始请求——它没有收到确认——已经获取了锁。 </p>
<img src="/2022/09/01/MIT6-824/image-20230405195601354.png" alt="image-20230405195601354" style="zoom:50%;">

<p>我们在 Raft 中的目标是实现可线性化的语义 ，从而避免这些类别的问题。 在可线性化中，每个操作都立即执行，精确的一次，在它的调用和响应之间的某一时间点。 这是一种强一致性形式，对于客户端进行推理，并且它不允许多次处理命令。</p>
<p>为了在Raft中实现线性化，服务器必须过滤掉重复的请求。基本思想是服务器保存客户端操作的结果，并使用它们跳过执行相同的请求。 </p>
<p>为了实现这一点，每个client都有一个唯一的标识符，client为每个命令分配唯一的序列号。 每个server的状态机为每个client维护一个session。该会话跟踪被client处理的最新序列号，以及相关的响应。 如果server收到序列号已经被执行过的命令，它会立即响应，而不会重新执行该请求。</p>
<p>有了重复请求的过滤，Raft提供了线性化。Raft日志提供了一个在每台服务器上应用命令的串行顺序。命令根据它们在 Raft 日志中的第一次出现立即生效，并且恰好一次，因为任何后续出现都会被状态机过滤掉。</p>
<p>client会记录它已经发送的请求序列号和对应的响应，以确保不会丢失或重复处理请求。同时，cilent还会告诉server它尚未收到的最低序列号，以确保server不会重复发送之前已经发送过的响应。server则会根据client的请求序列号和最低未收到响应的序列号，保证client能够正确处理所有请求。如果client已经收到了某个序列号的响应，那么它可以丢弃所有低于该序列号的响应，因为这些响应已经不再需要了</p>
<p>不幸的是，由于空间有限，会话不能永远保存。服务器最终必须决定终止客户端的会话，但这会产生两个问题:</p>
<ol>
<li>服务器何时使客户端的会话过期</li>
<li>如何处理会话被过早终止的活动客户端</li>
</ol>
<p>服务器必须就客户端会话何时过期达成一致； 否则，服务器的状态机可能会彼此不同。 例如，假设一个服务器使特定客户端的会话过期，然后重新应用该客户端的许多重复命令； 同时，其他服务器使会话保持活动状态并且不应用重复项。 复制的状态机将变得不一致。 为避免此类问题，会话过期必须是确定性的，就像正常的状态机操作一样。 </p>
<p>一种选择是设置会话数量的上限并使用 LRU（最近最少使用）策略删除条目。 </p>
<p>另一种选择是根据商定的时间源使会话过期。</p>
<p>在 LogCabin 中，领导者使用当前时间来增加它附加到 Raft 日志的每个命令。 作为提交日志条目的一部分，服务器就此时间达成一致； 然后，状态机确定性地使用这个时间输入来使非活动会话过期。 Live clients 在不活动期间发出 keep-alive 请求，这些请求也增加了 leader 的时间戳并提交到 Raft 日志，以维持他们的会话。</p>
<p>第二个问题是如何处理会话过期后继续运行的客户端。 我们希望这是一种特殊情况； 然而，它总是存在一些风险，因为通常无法知道客户何时退出。 一种选择是在没有记录的任何时候为客户端分配一个新会话，但这会冒重复执行的风险<br>在客户端的上一个会话过期之前执行的命令。 为了提供更严格的保证，服务器需要区分新客户端和会话已过期的客户端。 当客户端首次启动时，它可以使用 RegisterClient RPC 将自己注册到集群。 这会分配新客户端的会话并向客户端返回其标识符，客户端将其包含在所有后续命令中。 如果状态机遇到没有会话记录的命令，它不会处理该命令，而是向客户端返回错误。 在这种情况下，LogCabin 当前会导致客户端崩溃（大多数客户端可能不会优雅且正确地处理会话过期错误，但系统通常必须已经处理客户端崩溃）。</p>
<h3 id="Lab-4-Sharded-Key-x2F-Value-Service"><a href="#Lab-4-Sharded-Key-x2F-Value-Service" class="headerlink" title="Lab 4: Sharded Key&#x2F;Value Service"></a>Lab 4: Sharded Key&#x2F;Value Service</h3><p>In this lab you’ll build a key&#x2F;value storage system that “shards,” or partitions.</p>
<p>for example, all the keys starting with “a” might be one shard, all the keys starting with “b” another, etc</p>
<p>Your sharded key&#x2F;value store will have two main components. <strong>First, a set of replica groups.</strong> Each replica group is responsible for a subset of the shards.A replica consists of a handful of servers that use Raft to replicate the group’s shards. </p>
<p>第二个组成部分是“shard controller”。分片控制器决定哪个复制组应该为每个分片提供服务；这些信息称为配置。配置随时间变化。客户端向分片控制器查询以找到密钥的复制组，而复制组向控制器查询以找出要提供服务的分片。整个系统只有一个分片控制器，使用Raft实现为容错服务。</p>
<p><strong>难点</strong></p>
<p>一个分片存储系统必须能够在复制组之间转移分片。一个原因是某些组可能比其他组负载更重，因此需要移动分片以平衡负载。另一个原因是复制组可能加入和离开系统：新的复制组可以添加以增加容量，或者现有的复制组可能因维修或退役而下线。</p>
<p>本实验的主要挑战在于处理重新配置 - 分配分片到组的更改。在单个复制组内，所有组成员必须在客户端Put&#x2F;Append&#x2F;Get请求与重新配置之间达成一致。例如，当一个Put到达时，可能同时发生了一个重新配置，导致复制组不再负责持有Put密钥的分片。组中的所有副本必须就Put是否发生在重新配置之前或之后达成一致。如果在之前，Put应该生效，分片的新所有者将看到其效果；如果在之后，Put将不会生效，客户端必须在新的所有者处重试。建议的方法是让每个复制组使用Raft来记录不仅是Put，Append和Get序列，还要记录重新配置的序列。您需要确保每个分片在任何时间内最多由一个复制组为请求提供服务。</p>
<p>重新配置还需要复制组之间的交互。例如，在配置10中，组G1可能负责分片S1。在配置11中，组G2可能负责分片S1。在从10到11的重新配置期间，G1和G2必须使用RPC将S1的内容（键&#x2F;值对）从G1移动到G2。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/MIT6-824/" rel="tag"># MIT6.824</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/08/26/flutter/" rel="prev" title="flutter">
      <i class="fa fa-chevron-left"></i> flutter
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/09/26/Linux/" rel="next" title="Linux">
      Linux <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="nav-number">1.</span> <span class="nav-text">文件结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Lab-1-MapReduce"><span class="nav-number">2.</span> <span class="nav-text">Lab 1: MapReduce</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-few-rules"><span class="nav-number">2.1.</span> <span class="nav-text">A few rules:</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Hints"><span class="nav-number">2.2.</span> <span class="nav-text">Hints</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%80%BB%E6%B5%81%E7%A8%8B"><span class="nav-number">2.3.</span> <span class="nav-text">※流程</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Worker-%E6%A8%A1%E5%9D%97"><span class="nav-number">2.3.1.</span> <span class="nav-text">Worker 模块</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Lab-2A-Raft"><span class="nav-number">3.</span> <span class="nav-text">Lab 2A: Raft</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Lab3-%E9%AB%98%E5%8F%AF%E7%94%A8%E7%9A%84-KV-%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1"><span class="nav-number">4.</span> <span class="nav-text">Lab3:高可用的 KV 存储服务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-Finding-the-cluster"><span class="nav-number">4.1.</span> <span class="nav-text">1. Finding the cluster</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-Routing-requests-to-the-leader"><span class="nav-number">4.2.</span> <span class="nav-text">2. Routing requests to the leader</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-Implementing-linearizable-semantics%E8%AF%AD%E4%B9%89"><span class="nav-number">4.3.</span> <span class="nav-text">3. Implementing linearizable semantics语义</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Lab-4-Sharded-Key-x2F-Value-Service"><span class="nav-number">5.</span> <span class="nav-text">Lab 4: Sharded Key&#x2F;Value Service</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="kjg"
      src="/images/WechatIMG84.jpeg">
  <p class="site-author-name" itemprop="name">kjg</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">163</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">69</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/kjgggggg" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;kjgggggg" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/651373472@qq.com" title="E-Mail → 651373472@qq.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
</div>

<span style="text-align:center;display:block;">
<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span <div>wmr</div> </span>
</span>

        
<span style="text-align:center;display:block;">
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        本站总访问人数：
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider"></span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        本站总访问量： 
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
</span>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>


  <script defer src="/lib/three/three.min.js"></script>
    <script defer src="/lib/three/canvas_lines.min.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  
<script src="https://unpkg.com/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '16px',
  right: '28px',
  left: 'unset',
  time: '0.3s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>

</body>
</html>
